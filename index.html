<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tahiti | An Exploration [SECURE]</title>
    
    <!-- Leaflet CSS with Subresource Integrity (SRI) - MITIGATION FOR B-001 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* [NO CHANGE TO CORE DESIGN] */
        :root {
            --deep-lagoon: #0a192f;
            --sunlit-shallows: #64ffda;
            --pearl: #ccd6f6;
            --pearl-muted: #8892b0;
            --volcanic-glass: rgba(25, 45, 65, 0.7);
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        html { box-sizing: border-box; font-size: 16px; }
        *, *:before, *:after { box-sizing: inherit; }
        body { margin: 0; padding: 0; background-color: var(--deep-lagoon); font-family: var(--font-sans); color: var(--pearl); overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; background: linear-gradient(-45deg, #0a192f, #0f2140, #0a192f, #112a4a); background-size: 400% 400%; animation: gradient-flow 15s ease-in-out infinite; }
        @keyframes gradient-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .leaflet-tile-pane { }
        .leaflet-control-zoom { display: none; }
        .leaflet-marker-icon.custom-marker { border-radius: 50%; background-color: rgba(100, 255, 218, 0.8); border: 2px solid var(--sunlit-shallows); box-shadow: 0 0 15px var(--sunlit-shallows); transition: transform 0.3s ease-in-out; }
        .leaflet-marker-icon.custom-marker::before { content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; border-radius: 50%; background-color: var(--sunlit-shallows); animation: pulse 2s infinite; z-index: -1; transform-origin: center; }
        .leaflet-marker-icon.custom-marker.active { transform: scale(1.5); box-shadow: 0 0 25px var(--sunlit-shallows), 0 0 35px var(--sunlit-shallows); }
        /* PALETTE UX: Styled tooltips for markers */
        .leaflet-tooltip.custom-tooltip { background-color: var(--deep-lagoon); border: 1px solid var(--sunlit-shallows); color: var(--sunlit-shallows); font-family: var(--font-sans); box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 0.8rem; padding: 0.25rem 0.5rem; border-radius: 4px; }
        .leaflet-tooltip-top:before { border-top-color: var(--sunlit-shallows); }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 70% { transform: scale(2.5); opacity: 0; } 100% { transform: scale(0.9); opacity: 0; } }
        .ui-container { position: absolute; z-index: 10; padding: 1.5rem; pointer-events: none; }
        .ui-container > * { pointer-events: auto; }
        #header { top: 0; left: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        #header h1 { font-size: 1.75rem; font-weight: 500; color: var(--pearl); margin: 0; letter-spacing: 0.5px; }
        #island-selector { display: flex; gap: 1.5rem; }
        .island-btn { background: none; border: none; color: var(--pearl-muted); font-family: var(--font-sans); font-size: 1rem; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; position: relative; padding: 0.5rem 0; }
        .island-btn::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background-color: var(--sunlit-shallows); transform: scaleX(0); transform-origin: right; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .island-btn:hover, .island-btn.active { color: var(--sunlit-shallows); transform: translateY(-2px); }
        .island-btn.active::after { transform: scaleX(1); transform-origin: left; }
        #attraction-dock-wrapper { bottom: 0; left: 0; width: 100%; }
        #attraction-dock { display: flex; gap: 1rem; overflow-x: auto; padding: 1.5rem; padding-top: 1rem; -ms-overflow-style: none; scrollbar-width: none; scroll-behavior: smooth; /* For keyboard nav */ }
        #attraction-dock::-webkit-scrollbar { display: none; }
        /* MITIGATION FOR B-004: Styling a <button> instead of a <div> */
        .attraction-card { flex: 0 0 320px; padding: 1.5rem; background: var(--volcanic-glass); border: 1px solid rgba(100, 255, 218, 0.1); border-radius: 12px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: transform 0.4s ease, box-shadow 0.4s ease; cursor: pointer; text-align: left; font-family: var(--font-sans); }
        .attraction-card:hover { transform: translateY(-10px); box-shadow: 0 10px 30px -15px rgba(0,0,0,0.7); }
        .attraction-card.active, .attraction-card:focus-visible { transform: translateY(-10px) scale(1.05); box-shadow: 0 0 20px -5px var(--sunlit-shallows); border-color: var(--sunlit-shallows); outline: none; }
        .attraction-card h3 { margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 500; color: var(--pearl); pointer-events: none; /* Allow click on child */ }
        .attraction-card p { margin: 0; font-size: 0.95rem; color: var(--pearl-muted); line-height: 1.5; pointer-events: none; /* Allow click on child */ }
        #welcome-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--deep-lagoon); z-index: 1000; display: flex; justify-content: center; align-items: center; transition: opacity 1.5s ease-in-out 1s; }
        #welcome-overlay.hidden { opacity: 0; pointer-events: none; }
        .typewriter h1 { font-size: 3rem; font-weight: 300; color: var(--pearl); overflow: hidden; border-right: .15em solid var(--sunlit-shallows); white-space: nowrap; margin: 0 auto; letter-spacing: .1em; animation: typing 2.5s steps(30, end), blink-caret .75s step-end infinite; }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: var(--sunlit-shallows); } }
        @media (max-width: 768px) { #header { flex-direction: column; align-items: flex-start; gap: 1rem; } #header h1 { font-size: 1.5rem; } .island-btn { font-size: 0.9rem; } #island-selector { gap: 1rem; } .attraction-card { flex-basis: 280px; } .typewriter h1 { font-size: 1.8rem; } }
    </style>
</head>
<body>

    <div id="welcome-overlay">
        <div class="typewriter"><h1>Discover Tahiti.</h1></div>
    </div>

    <div id="map"></div>

    <header id="header" class="ui-container">
        <h1>An Exploration</h1>
        <nav id="island-selector" aria-label="Choose island"></nav>
    </header>

    <div id="attraction-dock-wrapper" class="ui-container">
        <!-- PALETTE UX: Added aria-label for accessibility -->
        <div id="attraction-dock" tabindex="0" aria-label="Attractions list"></div>
    </div>

    <!-- Leaflet JS with SRI - MITIGATION FOR B-001 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    
    <script>
        // MITIGATION FOR B-003: Encapsulate all code in an IIFE to prevent global scope pollution
        (function() {
            'use strict'; // Enforce stricter parsing and error handling

            const islands = {
                tahiti: { name: 'Tahiti', coords: [-17.6509, -149.4260], zoom: 10 },
                moorea: { name: 'Moorea', coords: [-17.5369, -149.8292], zoom: 11 },
                boraBora: { name: 'Bora Bora', coords: [-16.5004, -151.7415], zoom: 12 },
            };
            const attractions = [
                // Ultrathink: Expanded existing content and added one new attraction per island.
                { id: 1, island: 'tahiti', name: 'Papeete Market', coords: [-17.5388, -149.5693], description: "The vibrant heart of the city, the Marché de Papeete is a bustling, two-story marketplace. Downstairs, find fresh fish, tropical fruits, and local delicacies like 'firi firi' donuts. Upstairs is a treasure trove of Polynesian crafts, from hand-woven hats to exquisite 'tifaifai' quilts." },
                { id: 2, island: 'tahiti', name: 'Fautaua Waterfall', coords: [-17.5786, -149.5256], description: "One of Tahiti's tallest cascades at 135m (443 ft), also known as Cascade de Fachoda. Reaching it requires a moderate hike through the lush Fautaua Valley, passing ancient ruins. A permit from Papeete Town Hall is needed, but the reward is a swim in a stunning natural pool." },
                { id: 3, island: 'tahiti', name: 'Point Venus', coords: [-17.4950, -149.4960], description: "A site of immense historical importance. It's here Captain Cook observed the 1769 transit of Venus. This northernmost point of Tahiti features a unique black sand beach, a picturesque 1868 lighthouse, and monuments commemorating the arrival of explorers and missionaries." },
                { id: 10, island: 'tahiti', name: 'Arahoho Blowhole', coords: [-17.5350, -149.4650], description: "A spectacular natural curiosity where waves crash into coastal lava tubes, forcing a powerful jet of seawater and mist into the air with a thundering sound. Located on the scenic east coast, it's a dramatic display of nature's power, especially during high tide." },
                { id: 4, island: 'moorea', name: 'Belvédère Lookout', coords: [-17.5406, -149.8202], description: "The most famous viewpoint on Moorea, offering a stunning panorama of the twin bays—Cook's Bay and Ōpūnohu Bay—separated by the majestic Mount Rotui. The viewpoint sits in the heart of the island's ancient volcanic crater, surrounded by lush pineapple fields." },
                { id: 5, island: 'moorea', name: 'Magic Mountain', coords: [-17.5117, -149.8660], description: "Accessible via a steep but rewarding hike or a 4WD tour, this peak offers an incredible 360-degree view of Moorea's northwestern coast and its turquoise lagoon. The journey is part of the adventure, culminating in one of the island's most 'Instagrammable' vistas." },
                { id: 6, island: 'moorea', name: 'Lagoonarium', coords: [-17.4878, -149.7618], description: "A protected, natural aquarium located on a small 'motu' (islet). A short boat ride takes you to a snorkeler's paradise where you can safely swim among dozens of blacktip sharks, gentle stingrays, and a dazzling array of colorful reef fish in a vibrant coral garden." },
                { id: 11, island: 'moorea', name: 'Toatea Lookout', coords: [-17.4910, -149.7750], description: "Offering a breathtaking view from a different perspective, this easily accessible lookout gazes over the stunning Sofitel resort's overwater bungalows, across the turquoise lagoon, towards the silhouette of Tahiti in the distance. It is particularly beautiful at sunrise." },
                { id: 7, island: 'boraBora', name: 'Mount Otemanu', coords: [-16.5052, -151.7335], description: "The soul of Bora Bora. This jagged, awe-inspiring remnant of an ancient volcano rises 727m (2,385 ft) over the lagoon. While its crumbly volcanic rock makes the summit inaccessible, its majestic presence can be admired from all angles via boat, 4WD, or helicopter tours." },
                { id: 8, island: 'boraBora', name: 'Matira Beach', coords: [-16.5365, -151.7317], description: "Bora Bora's only public beach and arguably one of the most beautiful in the world. A mile of powdery white sand slopes gently into a shallow, warm, crystal-clear turquoise lagoon. It's the perfect spot for swimming, sunbathing, and watching the spectacular sunset." },
                { id: 9, island: 'boraBora', name: 'Coral Gardens', coords: [-16.5181, -151.7058], description: "A world-renowned snorkeling spot, this is a natural underwater park teeming with life. Drift through warm, shallow waters and marvel at the intricate coral formations and the hundreds of colorful tropical fish that call this vibrant ecosystem home. A must-do on any lagoon tour." },
                { id: 12, island: 'boraBora', name: 'WWII Cannons', coords: [-16.4770, -151.7510], description: "A fascinating relic from a different era. After Pearl Harbor, the US established a supply base in Bora Bora. Today, you can find several massive coastal defense cannons still in their panoramic hillside placements, a stark contrast to the island's peaceful vibe. A 4x4 tour is the best way to see them." },
            ];

            document.addEventListener('DOMContentLoaded', () => {
                // MITIGATION FOR B-002: Wrap main logic in try/catch for robust error handling
                try {
                    initializeApplication();
                } catch (error) {
                    console.error("CATACLYSMIC FAILURE: Application initialization failed.", error);
                    // Optionally display a user-friendly error message on the page
                    document.body.innerHTML = '<div style="color: red; text-align: center; padding-top: 20%;">SYSTEM OFFLINE. A critical error occurred.</div>';
                }
            });

            function initializeApplication() {
                const welcomeOverlay = document.getElementById('welcome-overlay');
                setTimeout(() => { welcomeOverlay.classList.add('hidden'); }, 4000);

                const map = L.map('map', { zoomControl: false, attributionControl: false }).setView(islands.tahiti.coords, islands.tahiti.zoom);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                }).addTo(map);

                const dock = document.getElementById('attraction-dock');
                const islandSelector = document.getElementById('island-selector');
                
                const markers = {};
                let currentActiveId = null; // MITIGATION FOR B-006: State variable

                // Create Island Selector Buttons
                for (const islandKey in islands) {
                    const island = islands[islandKey];
                    const button = document.createElement('button');
                    button.className = 'island-btn';
                    button.textContent = island.name;
                    button.dataset.islandKey = islandKey;
                    // PALETTE UX: Accessibility improvements
                    const isActive = islandKey === 'tahiti';
                    if (isActive) button.classList.add('active');
                    button.setAttribute('aria-current', isActive ? 'true' : 'false');
                    islandSelector.appendChild(button);
                }

                // Create Attraction Cards and Markers
                attractions.forEach(attraction => {
                    // MITIGATION FOR B-004: Use semantic <button> for attraction cards
                    const card = document.createElement('button');
                    card.className = 'attraction-card';
                    card.dataset.id = attraction.id;
                    card.innerHTML = `<h3>${attraction.name}</h3><p>${attraction.description}</p>`;
                    dock.appendChild(card);
                    
                    const customIcon = L.divIcon({ className: 'custom-marker', html: '', iconSize: [16, 16], iconAnchor: [8, 8] });
                    // PALETTE UX: Added title for accessibility and styled tooltip for delight
                    const marker = L.marker(attraction.coords, { icon: customIcon, title: attraction.name }).addTo(map);
                    marker.bindTooltip(attraction.name, { offset: [0, -10], direction: 'top', className: 'custom-tooltip' });
                    marker.on('click', () => handleInteraction(attraction.id));
                    markers[attraction.id] = marker;
                });

                function handleInteraction(id) {
                    // MITIGATION FOR B-002: Validate that the attraction exists
                    const attraction = attractions.find(a => a.id === id);
                    if (!attraction) {
                        console.warn(`Interaction failed: No attraction found with ID ${id}.`);
                        return;
                    }

                    // MITIGATION B-007: Prevent user meddling during flight
                    map.dragging.disable();
                    map.touchZoom.disable();
                    map.doubleClickZoom.disable();
                    map.scrollWheelZoom.disable();

                    map.flyTo(attraction.coords, 14, { animate: true, duration: 1.5 });
                    map.once('moveend', () => {
                        map.dragging.enable();
                        map.touchZoom.enable();
                        map.doubleClickZoom.enable();
                        map.scrollWheelZoom.enable();
                    });

                    updateActiveStates(id);
                }

                function updateActiveStates(activeId) {
                    // MITIGATION FOR B-006: Efficient state update, no full traversals
                    if (currentActiveId === activeId) return; // No change needed

                    // Deactivate previous
                    if (currentActiveId) {
                        document.querySelector(`.attraction-card[data-id='${currentActiveId}']`)?.classList.remove('active');
                        markers[currentActiveId]?._icon?.classList.remove('active');
                    }

                    // Activate new
                    const activeCard = document.querySelector(`.attraction-card[data-id='${activeId}']`);
                    if (activeCard) {
                        activeCard.classList.add('active');
                        activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                    markers[activeId]?._icon?.classList.add('active');
                    
                    currentActiveId = activeId;
                }

                // MITIGATION FOR B-005: Use event delegation for attraction dock
                dock.addEventListener('click', (e) => {
                    const card = e.target.closest('.attraction-card');
                    if (card) {
                        const id = parseInt(card.dataset.id, 10);
                        handleInteraction(id);
                    }
                });
                
                // MITIGATION FOR B-004: Add keyboard navigation for the dock
                // PALETTE UX: Improved keyboard navigation (Focus Management) per Journal 2024-05-25
                dock.addEventListener('keydown', (e) => {
                    const cards = Array.from(dock.querySelectorAll('.attraction-card'));
                    const currentIndex = cards.indexOf(document.activeElement);

                    if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        const nextIndex = currentIndex + 1;
                        if (nextIndex < cards.length) cards[nextIndex].focus();
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        const prevIndex = currentIndex - 1;
                        if (prevIndex >= 0) cards[prevIndex].focus();
                    }
                });

                islandSelector.addEventListener('click', (e) => {
                    if (e.target.classList.contains('island-btn')) {
                        document.querySelectorAll('.island-btn').forEach(btn => {
                            btn.classList.remove('active');
                            btn.setAttribute('aria-current', 'false');
                        });
                        e.target.classList.add('active');
                        e.target.setAttribute('aria-current', 'true');

                        const island = islands[e.target.dataset.islandKey];
                        if(island) map.flyTo(island.coords, island.zoom, { duration: 2 });
                    }
                });
            }
        })();
    </script>
</body>
</html>
